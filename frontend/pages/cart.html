<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart - Kart Management</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="/" class="nav-brand">üõí Kart Management</a>
      <div class="nav-links">
        <a href="/catalog.html">üì¶ Catalog</a>
        <a href="/inventory.html">üìä Inventory</a>
        <a href="/cart.html" class="active">üõçÔ∏è Cart</a>
        <a href="/customers.html">üë• Customers</a>
        <a href="/dashboard.html">üìà Dashboard</a>
      </div>
    </div>
  </nav>

  <main>
    <div class="page-header">
      <h1>üõçÔ∏è Shopping Cart</h1>
    </div>

    <div class="card" style="margin-bottom: 2rem;">
      <div class="card-header">
        <h3 class="card-title">üë§ Step 1: Select Customer</h3>
        <button class="btn btn-primary btn-sm" onclick="toggleCustomerForm()">‚ûï Add New Customer</button>
      </div>
      <div class="card-body">
        <div id="customerSelection">
          <div class="form-group">
            <label>Select Customer *</label>
            <select id="customerSelect" onchange="loadCustomerDetails()">
              <option value="">-- Select Customer --</option>
            </select>
          </div>
          <div id="selectedCustomerInfo" style="display:none; padding: 1rem; background: var(--dark); border-radius: 8px; margin-top: 1rem;">
            <p><strong>Name:</strong> <span id="custName"></span></p>
            <p><strong>Email:</strong> <span id="custEmail"></span></p>
            <p><strong>Phone:</strong> <span id="custPhone"></span></p>
            <p><strong>Address:</strong> <span id="custAddress"></span></p>
          </div>
        </div>
        
        <div id="newCustomerForm" style="display:none; margin-top: 1rem;">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" id="newCustName" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="newCustEmail" required>
          </div>
          <div class="form-group">
            <label>Phone *</label>
            <input type="tel" id="newCustPhone" required>
          </div>
          <div class="form-group">
            <label>Address *</label>
            <textarea id="newCustAddress" required></textarea>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" onclick="saveNewCustomer()">üíæ Save Customer</button>
            <button class="btn btn-secondary" onclick="toggleCustomerForm()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div id="cartSection" style="display:none;">
      <div class="page-header">
        <h3>üì¶ Step 2: Add Products</h3>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="openAddModal()">‚ûï Add Item</button>
          <button class="btn btn-danger" onclick="clearCart()">üóëÔ∏è Clear Cart</button>
          <button class="btn btn-success" onclick="exportUtils.exportCartCSV(cartItems)">üìÑ Export CSV</button>
          <button class="btn btn-secondary" onclick="exportUtils.exportCartPDF(cartItems)">üìë Export PDF</button>
        </div>
      </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon primary">üõçÔ∏è</div>
        <div class="stat-info">
          <h3>Total Items</h3>
          <p id="totalItems">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon success">üí∞</div>
        <div class="stat-info">
          <h3>Total Price</h3>
          <p id="totalPrice">‚Çπ0.00</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon warning">üì¶</div>
        <div class="stat-info">
          <h3>Unique Products</h3>
          <p id="uniqueProducts">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon danger">üí≥</div>
        <div class="stat-info">
          <h3>Avg Price</h3>
          <p id="avgPrice">‚Çπ0.00</p>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="cartTable"></tbody>
      </table>
    </div>

    <div id="emptyCart" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üõí</div>
      <h3>Your cart is empty</h3>
      <p>Add some products to get started</p>
      <button class="btn btn-primary" onclick="openAddModal()">Browse Products</button>
    </div>

      <div style="margin-top: 2rem; text-align: right;">
        <button class="btn btn-success" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="checkout()">
          üí≥ Checkout - <span id="checkoutTotal">‚Çπ0.00</span>
        </button>
      </div>
    </div>
  </main>

  <!-- Add Item Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add to Cart</h2>
        <button class="close-btn" onclick="closeAddModal()">‚úï</button>
      </div>
      <form id="addForm" onsubmit="addToCart(event)">
        <div class="form-group">
          <label>Select Product *</label>
          <select id="productSelect" required onchange="updatePrice()">
            <option value="">-- Select Product --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Price</label>
          <input type="text" id="selectedPrice" readonly>
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input type="number" id="quantity" value="1" min="1" required>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-success">‚ûï Add to Cart</button>
          <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Item Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Update Quantity</h2>
        <button class="close-btn" onclick="closeEditModal()">‚úï</button>
      </div>
      <form id="editForm" onsubmit="updateCartItem(event)">
        <div class="form-group">
          <label>Product</label>
          <input type="text" id="editProductName" readonly>
        </div>
        <div class="form-group">
          <label>Quantity *</label>
          <input type="number" id="editQuantity" min="1" required>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-success">üíæ Update</button>
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/utils/export.js"></script>
  <script>
    let cartItems = [];
    let products = [];
    let customers = [];
    let selectedCustomerId = null;
    let editingItemId = null;

    async function loadCart() {
      try {
        const res = await fetch('/api/cart');
        const data = await res.json();
        cartItems = data.data || [];
        renderCart();
        updateStats();
      } catch (error) {
        console.error('Error loading cart:', error);
      }
    }

    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        products = data.data || [];
        populateProductSelect();
      } catch (error) {
        console.error('Error loading products:', error);
      }
    }

    function populateProductSelect() {
      const select = document.getElementById('productSelect');
      select.innerHTML = '<option value="">-- Select Product --</option>' +
        products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - ‚Çπ${parseFloat(p.price).toFixed(2)}</option>`).join('');
    }

    function updatePrice() {
      const select = document.getElementById('productSelect');
      const price = select.options[select.selectedIndex]?.dataset.price || '0';
      document.getElementById('selectedPrice').value = '‚Çπ' + parseFloat(price).toFixed(2);
    }

    function renderCart() {
      const tbody = document.getElementById('cartTable');
      const emptyCart = document.getElementById('emptyCart');
      
      if (cartItems.length === 0) {
        tbody.parentElement.parentElement.style.display = 'none';
        emptyCart.style.display = 'block';
        return;
      }
      
      tbody.parentElement.parentElement.style.display = 'block';
      emptyCart.style.display = 'none';
      
      tbody.innerHTML = cartItems.map(item => {
        const subtotal = item.price * item.quantity;
        return `
          <tr>
            <td><strong>${item.name}</strong></td>
            <td>‚Çπ${parseFloat(item.price).toFixed(2)}</td>
            <td>${item.quantity}</td>
            <td><strong>‚Çπ${subtotal.toFixed(2)}</strong></td>
            <td>
              <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="editItem(${item.id})">‚úèÔ∏è</button>
                <button class="btn btn-success btn-sm" onclick="increaseQty(${item.id})">‚ûï</button>
                <button class="btn btn-warning btn-sm" onclick="decreaseQty(${item.id})">‚ûñ</button>
                <button class="btn btn-danger btn-sm" onclick="removeItem(${item.id})">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateStats() {
      const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
      const totalPrice = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const uniqueProducts = cartItems.length;
      const avgPrice = uniqueProducts > 0 ? totalPrice / totalItems : 0;
      
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalPrice').textContent = '‚Çπ' + totalPrice.toFixed(2);
      document.getElementById('uniqueProducts').textContent = uniqueProducts;
      document.getElementById('avgPrice').textContent = '‚Çπ' + avgPrice.toFixed(2);
      document.getElementById('checkoutTotal').textContent = '‚Çπ' + totalPrice.toFixed(2);
    }

    function openAddModal() {
      if (!selectedCustomerId) {
        alert('Please select a customer first!');
        return;
      }
      document.getElementById('addForm').reset();
      document.getElementById('selectedPrice').value = '';
      document.getElementById('addModal').classList.add('active');
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.remove('active');
    }

    async function addToCart(e) {
      e.preventDefault();
      
      const productId = document.getElementById('productSelect').value;
      const quantity = parseInt(document.getElementById('quantity').value);
      
      const product = products.find(p => p.id == productId);
      if (!product) return;
      
      try {
        const res = await fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            product_id: product.id,
            quantity: quantity
          })
        });
        
        if (res.ok) {
          closeAddModal();
          loadCart();
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
        alert('Failed to add item to cart');
      }
    }

    function editItem(id) {
      const item = cartItems.find(i => i.id === id);
      if (!item) return;
      
      editingItemId = id;
      document.getElementById('editProductName').value = item.name;
      document.getElementById('editQuantity').value = item.quantity;
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      editingItemId = null;
    }

    async function updateCartItem(e) {
      e.preventDefault();
      
      const quantity = parseInt(document.getElementById('editQuantity').value);
      
      try {
        const res = await fetch(`/api/cart/${editingItemId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity })
        });
        
        if (res.ok) {
          closeEditModal();
          loadCart();
        }
      } catch (error) {
        console.error('Error updating cart item:', error);
        alert('Failed to update item');
      }
    }

    async function removeItem(id) {
      if (!confirm('Remove this item from cart?')) return;
      
      try {
        const res = await fetch(`/api/cart/${id}`, { method: 'DELETE' });
        if (res.ok) {
          loadCart();
        }
      } catch (error) {
        console.error('Error removing item:', error);
        alert('Failed to remove item');
      }
    }

    async function increaseQty(id) {
      const item = cartItems.find(i => i.id === id);
      if (!item) return;
      
      try {
        const res = await fetch(`/api/cart/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: item.quantity + 1 })
        });
        
        if (res.ok) loadCart();
      } catch (error) {
        console.error('Error updating quantity:', error);
      }
    }

    async function decreaseQty(id) {
      const item = cartItems.find(i => i.id === id);
      if (!item || item.quantity <= 1) return;
      
      try {
        const res = await fetch(`/api/cart/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: item.quantity - 1 })
        });
        
        if (res.ok) loadCart();
      } catch (error) {
        console.error('Error updating quantity:', error);
      }
    }

    async function clearCart() {
      if (!confirm('Clear all items from cart?')) return;
      
      for (const item of cartItems) {
        await fetch(`/api/cart/${item.id}`, { method: 'DELETE' });
      }
      loadCart();
    }

    async function checkout() {
      if (cartItems.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      
      if (!selectedCustomerId) {
        alert('Please select a customer before checkout!');
        return;
      }
      
      const totalAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const orderData = {
        customer_id: selectedCustomerId,
        total_amount: totalAmount,
        status: 'Completed',
        items: cartItems.map(item => ({
          product_id: item.product_id,
          product_name: item.name,
          quantity: item.quantity,
          price: item.price
        }))
      };
      
      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });
        const data = await res.json();
        
        if (data.status === 'created') {
          alert(`Order #${data.data.id} created successfully!\nTotal: ‚Çπ${totalAmount.toFixed(2)}`);
          
          // Clear cart items from database
          for (const item of cartItems) {
            await fetch(`/api/cart/${item.id}`, { method: 'DELETE' });
          }
          
          // Reset UI
          selectedCustomerId = null;
          document.getElementById('customerSelect').value = '';
          document.getElementById('selectedCustomerInfo').style.display = 'none';
          await loadCart();
        }
      } catch (error) {
        console.error('Error creating order:', error);
        alert('Failed to create order');
      }
    }

    async function loadCustomers() {
      try {
        const res = await fetch('/api/customers');
        const data = await res.json();
        customers = data.data || [];
        populateCustomerSelect();
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    function populateCustomerSelect() {
      const select = document.getElementById('customerSelect');
      select.innerHTML = '<option value="">-- Select Customer --</option>' +
        customers.map(c => `<option value="${c.id}">${c.name} (${c.email})</option>`).join('');
    }

    function loadCustomerDetails() {
      const select = document.getElementById('customerSelect');
      selectedCustomerId = parseInt(select.value) || null;
      
      if (!selectedCustomerId) {
        document.getElementById('selectedCustomerInfo').style.display = 'none';
        document.getElementById('cartSection').style.display = 'none';
        return;
      }
      
      const customer = customers.find(c => c.id === selectedCustomerId);
      if (customer) {
        document.getElementById('custName').textContent = customer.name;
        document.getElementById('custEmail').textContent = customer.email;
        document.getElementById('custPhone').textContent = customer.phone || 'N/A';
        document.getElementById('custAddress').textContent = customer.address || 'N/A';
        document.getElementById('selectedCustomerInfo').style.display = 'block';
        document.getElementById('cartSection').style.display = 'block';
        loadCart();
      }
    }

    function toggleCustomerForm() {
      const form = document.getElementById('newCustomerForm');
      const selection = document.getElementById('customerSelection');
      
      if (form.style.display === 'none') {
        form.style.display = 'block';
        selection.style.display = 'none';
      } else {
        form.style.display = 'none';
        selection.style.display = 'block';
      }
    }

    async function saveNewCustomer() {
      const data = {
        name: document.getElementById('newCustName').value,
        email: document.getElementById('newCustEmail').value,
        phone: document.getElementById('newCustPhone').value,
        address: document.getElementById('newCustAddress').value
      };
      
      if (!data.name || !data.email || !data.phone || !data.address) {
        alert('Please fill all required fields');
        return;
      }
      
      try {
        const res = await fetch('/api/customers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          const result = await res.json();
          alert('Customer added successfully!');
          await loadCustomers();
          selectedCustomerId = result.data.id;
          document.getElementById('customerSelect').value = selectedCustomerId;
          toggleCustomerForm();
          loadCustomerDetails();
        }
      } catch (error) {
        console.error('Error saving customer:', error);
        alert('Failed to save customer');
      }
    }

    loadProducts();
    loadCustomers();
  </script>
</body>
</html>
