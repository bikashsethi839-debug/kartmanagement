<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalog - Kart Management</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="/" class="nav-brand">üõí Kart Management</a>
      <div class="nav-links">
        <a href="/catalog.html" class="active">üì¶ Catalog</a>
        <a href="/inventory.html">üìä Inventory</a>
        <a href="/cart.html">üõçÔ∏è Cart</a>
        <a href="/dashboard.html">üìà Dashboard</a>
      </div>
    </div>
  </nav>

  <main>
    <div class="page-header">
      <h1>üì¶ Product Catalog</h1>
      <button class="btn btn-primary" onclick="openAddModal()">‚ûï Add Product</button>
    </div>

    <div class="search-bar">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Search products..." onkeyup="filterProducts()">
    </div>

    <div id="products" class="grid"></div>
    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üì¶</div>
      <h3>No products found</h3>
      <p>Start by adding your first product</p>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Product</h2>
        <button class="close-btn" onclick="closeModal()">‚úï</button>
      </div>
      <form id="productForm" onsubmit="saveProduct(event)">
        <div class="form-group">
          <label>Product Name *</label>
          <input type="text" id="productName" required>
        </div>
        <div class="form-group">
          <label>SKU</label>
          <input type="text" id="productSku">
        </div>
        <div class="form-group">
          <label>Price *</label>
          <input type="number" id="productPrice" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Stock *</label>
          <input type="number" id="productStock" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="productDescription"></textarea>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-success">üíæ Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/assets/js/app.js"></script>
  <script>
    let products = [];
    let editingId = null;

    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        products = data.data || [];
        renderProducts();
      } catch (error) {
        console.error('Error loading products:', error);
      }
    }

    function renderProducts() {
      const container = document.getElementById('products');
      const emptyState = document.getElementById('emptyState');
      
      if (products.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      container.style.display = 'grid';
      emptyState.style.display = 'none';
      
      container.innerHTML = products.map(p => `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">${p.name}</h3>
            <span class="badge ${p.stock > 10 ? 'badge-success' : p.stock > 0 ? 'badge-warning' : 'badge-danger'}">
              ${p.stock} in stock
            </span>
          </div>
          <div class="card-body">
            <p><strong>SKU:</strong> ${p.sku || 'N/A'}</p>
            <p><strong>Price:</strong> $${parseFloat(p.price).toFixed(2)}</p>
            <p><strong>Description:</strong> ${p.description || 'No description'}</p>
          </div>
          <div class="btn-group">
            <button class="btn btn-primary btn-sm" onclick="editProduct(${p.id})">‚úèÔ∏è Edit</button>
            <button class="btn btn-warning btn-sm" onclick="viewDetails(${p.id})">üëÅÔ∏è View</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    }

    function filterProducts() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = products.filter(p => 
        p.name.toLowerCase().includes(search) || 
        (p.sku && p.sku.toLowerCase().includes(search)) ||
        (p.description && p.description.toLowerCase().includes(search))
      );
      
      const container = document.getElementById('products');
      container.innerHTML = filtered.map(p => `
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">${p.name}</h3>
            <span class="badge ${p.stock > 10 ? 'badge-success' : p.stock > 0 ? 'badge-warning' : 'badge-danger'}">
              ${p.stock} in stock
            </span>
          </div>
          <div class="card-body">
            <p><strong>SKU:</strong> ${p.sku || 'N/A'}</p>
            <p><strong>Price:</strong> $${parseFloat(p.price).toFixed(2)}</p>
            <p><strong>Description:</strong> ${p.description || 'No description'}</p>
          </div>
          <div class="btn-group">
            <button class="btn btn-primary btn-sm" onclick="editProduct(${p.id})">‚úèÔ∏è Edit</button>
            <button class="btn btn-warning btn-sm" onclick="viewDetails(${p.id})">üëÅÔ∏è View</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">üóëÔ∏è Delete</button>
          </div>
        </div>
      `).join('');
    }

    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Product';
      document.getElementById('productForm').reset();
      document.getElementById('productModal').classList.add('active');
    }

    function editProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Product';
      document.getElementById('productName').value = product.name;
      document.getElementById('productSku').value = product.sku || '';
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productStock').value = product.stock;
      document.getElementById('productDescription').value = product.description || '';
      document.getElementById('productModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('productModal').classList.remove('active');
      editingId = null;
    }

    async function saveProduct(e) {
      e.preventDefault();
      
      const data = {
        name: document.getElementById('productName').value,
        sku: document.getElementById('productSku').value,
        price: parseFloat(document.getElementById('productPrice').value),
        stock: parseInt(document.getElementById('productStock').value),
        description: document.getElementById('productDescription').value
      };
      
      try {
        const url = editingId ? `/api/products/${editingId}` : '/api/products';
        const method = editingId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          closeModal();
          loadProducts();
        }
      } catch (error) {
        console.error('Error saving product:', error);
        alert('Failed to save product');
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      try {
        const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
        if (res.ok) {
          loadProducts();
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        alert('Failed to delete product');
      }
    }

    function viewDetails(id) {
      window.location.href = `/product.html?id=${id}`;
    }

    loadProducts();
  </script>
</body>
</html>
