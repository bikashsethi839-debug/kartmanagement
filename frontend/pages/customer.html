<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Profile - Kart Management</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="/" class="nav-brand">ğŸ›’ Kart Management</a>
      <div class="nav-links">
        <a href="/catalog.html">ğŸ“¦ Catalog</a>
        <a href="/inventory.html">ğŸ“Š Inventory</a>
        <a href="/cart.html">ğŸ›ï¸ Cart</a>
        <a href="/customers.html" class="active">ğŸ‘¥ Customers</a>
        <a href="/dashboard.html">ğŸ“ˆ Dashboard</a>
      </div>
    </div>
  </nav>

  <main>
    <div class="page-header">
      <h1>ğŸ‘¤ Customer Profile</h1>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="window.history.back()">â† Back</button>
        <button class="btn btn-primary" onclick="editCustomer()">âœï¸ Edit</button>
        <button class="btn btn-success" onclick="exportCustomerData()">ğŸ“„ Export CSV</button>
        <button class="btn btn-secondary" onclick="exportCustomerPDF()">ğŸ“‘ Export PDF</button>
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Customer Information</h3>
        </div>
        <div class="card-body">
          <div style="margin-bottom: 1rem;">
            <label style="color: var(--text-muted);">Name</label>
            <p id="customerName" style="font-size: 1.2rem; font-weight: 600;"></p>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="color: var(--text-muted);">Email</label>
            <p id="customerEmail"></p>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="color: var(--text-muted);">Phone</label>
            <p id="customerPhone"></p>
          </div>
          <div>
            <label style="color: var(--text-muted);">Address</label>
            <p id="customerAddress"></p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Order Statistics</h3>
        </div>
        <div class="stats-grid" style="margin: 0;">
          <div class="stat-card">
            <div class="stat-icon primary">ğŸ“¦</div>
            <div class="stat-info">
              <h3>Total Orders</h3>
              <p id="totalOrders">0</p>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon success">ğŸ’°</div>
            <div class="stat-info">
              <h3>Total Spent</h3>
              <p id="totalSpent">â‚¹0</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 1.5rem;">
      <div class="card-header">
        <h3 class="card-title">Order History</h3>
        <button class="btn btn-primary btn-sm" onclick="createOrder()">â• New Order</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>Total Amount</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>
      <div id="noOrders" class="empty-state" style="display:none;">
        <div class="empty-state-icon">ğŸ“¦</div>
        <h3>No orders yet</h3>
        <p>This customer hasn't placed any orders</p>
      </div>
    </div>
  </main>

  <!-- Edit Customer Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Customer</h2>
        <button class="close-btn" onclick="closeEditModal()">âœ•</button>
      </div>
      <form id="editForm" onsubmit="saveCustomer(event)">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="editName" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="editEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="editPhone">
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea id="editAddress"></textarea>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-success">ğŸ’¾ Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/utils/export.js"></script>
  <script>
    let customer = null;
    let orders = [];
    let customerId = null;

    function getCustomerId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    async function loadCustomer() {
      customerId = getCustomerId();
      if (!customerId) {
        alert('No customer ID specified');
        window.location.href = '/customers.html';
        return;
      }

      try {
        const res = await fetch(`/api/customers/${customerId}`);
        const data = await res.json();
        customer = data.data;
        renderCustomer();
        loadOrders();
      } catch (error) {
        console.error('Error loading customer:', error);
        alert('Customer not found');
        window.location.href = '/customers.html';
      }
    }

    function renderCustomer() {
      if (!customer) return;

      document.getElementById('customerName').textContent = customer.name;
      document.getElementById('customerEmail').textContent = customer.email;
      document.getElementById('customerPhone').textContent = customer.phone || 'N/A';
      document.getElementById('customerAddress').textContent = customer.address || 'N/A';
    }

    async function loadOrders() {
      try {
        const res = await fetch(`/api/customers/${customerId}/orders`);
        const data = await res.json();
        orders = data.data || [];
        renderOrders();
        updateStats();
      } catch (error) {
        console.error('Error loading orders:', error);
      }
    }

    function renderOrders() {
      const tbody = document.getElementById('ordersTable');
      const noOrders = document.getElementById('noOrders');

      if (orders.length === 0) {
        tbody.parentElement.parentElement.style.display = 'none';
        noOrders.style.display = 'block';
        return;
      }

      tbody.parentElement.parentElement.style.display = 'block';
      noOrders.style.display = 'none';

      tbody.innerHTML = orders.map(order => {
        const statusClass = order.status === 'Completed' ? 'badge-success' : 
                           order.status === 'Pending' ? 'badge-warning' : 'badge-primary';
        const date = new Date(order.created_at).toLocaleDateString();
        
        return `
          <tr>
            <td><strong>#${order.id}</strong></td>
            <td>${date}</td>
            <td>â‚¹${parseFloat(order.total_amount).toFixed(2)}</td>
            <td><span class="badge ${statusClass}">${order.status}</span></td>
            <td>
              <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="viewOrder(${order.id})">ğŸ‘ï¸ View</button>
                <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.id})">ğŸ—‘ï¸</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateStats() {
      const totalOrders = orders.length;
      const totalSpent = orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);

      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('totalSpent').textContent = 'â‚¹' + totalSpent.toFixed(2);
    }

    function editCustomer() {
      document.getElementById('editName').value = customer.name;
      document.getElementById('editEmail').value = customer.email;
      document.getElementById('editPhone').value = customer.phone || '';
      document.getElementById('editAddress').value = customer.address || '';
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    async function saveCustomer(e) {
      e.preventDefault();

      const data = {
        name: document.getElementById('editName').value,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
        address: document.getElementById('editAddress').value
      };

      try {
        const res = await fetch(`/api/customers/${customerId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          closeEditModal();
          loadCustomer();
        }
      } catch (error) {
        console.error('Error saving customer:', error);
        alert('Failed to save customer');
      }
    }

    function createOrder() {
      window.location.href = `/cart.html?customer=${customerId}`;
    }

    function viewOrder(orderId) {
      alert(`View order #${orderId} - Feature coming soon`);
    }

    async function deleteOrder(orderId) {
      if (!confirm('Delete this order?')) return;

      try {
        const res = await fetch(`/api/orders/${orderId}`, { method: 'DELETE' });
        if (res.ok) {
          loadOrders();
        }
      } catch (error) {
        console.error('Error deleting order:', error);
        alert('Failed to delete order');
      }
    }

    function exportCustomerData() {
      const data = orders.map(order => ({
        'Order ID': order.id,
        'Date': new Date(order.created_at).toLocaleDateString(),
        'Amount': order.total_amount,
        'Status': order.status
      }));

      exportUtils.exportToCSV(data, `customer_${customer.name}_orders_${Date.now()}.csv`);
    }

    function exportCustomerPDF() {
      const data = orders.map(order => ({
        'Order ID': `#${order.id}`,
        'Date': new Date(order.created_at).toLocaleDateString(),
        'Amount': `â‚¹${parseFloat(order.total_amount).toFixed(2)}`,
        'Status': order.status
      }));

      exportUtils.exportToPDF(`${customer.name} - Order History`, data, `customer_${customer.name}_${Date.now()}.pdf`);
    }

    loadCustomer();
  </script>
</body>
</html>
