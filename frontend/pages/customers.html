<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers - Kart Management</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="/" class="nav-brand">ğŸ›’ Kart Management</a>
      <div class="nav-links">
        <a href="/catalog.html">ğŸ“¦ Catalog</a>
        <a href="/inventory.html">ğŸ“Š Inventory</a>
        <a href="/cart.html">ğŸ›ï¸ Cart</a>
        <a href="/customers.html" class="active">ğŸ‘¥ Customers</a>
        <a href="/dashboard.html">ğŸ“ˆ Dashboard</a>
      </div>
    </div>
  </nav>

  <main>
    <div class="page-header">
      <h1>ğŸ‘¥ Customers</h1>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="openAddModal()">â• Add Customer</button>
        <button class="btn btn-success" onclick="exportCustomersCSV()">ğŸ“„ Export CSV</button>
        <button class="btn btn-secondary" onclick="exportCustomersPDF()">ğŸ“‘ Export PDF</button>
      </div>
    </div>

    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="Search customers..." onkeyup="filterCustomers()">
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Registered</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customersTable"></tbody>
      </table>
    </div>

    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">ğŸ‘¥</div>
      <h3>No customers found</h3>
      <p>Add your first customer to get started</p>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Customer</h2>
        <button class="close-btn" onclick="closeModal()">âœ•</button>
      </div>
      <form id="customerForm" onsubmit="saveCustomer(event)">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="customerName" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="customerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="customerPhone">
        </div>
        <div class="form-group">
          <label>Address</label>
          <textarea id="customerAddress"></textarea>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-success">ğŸ’¾ Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/utils/export.js"></script>
  <script>
    let customers = [];
    let editingId = null;

    async function loadCustomers() {
      try {
        const res = await fetch('/api/customers');
        const data = await res.json();
        customers = data.data || [];
        renderCustomers();
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    function renderCustomers() {
      const tbody = document.getElementById('customersTable');
      const emptyState = document.getElementById('emptyState');

      if (customers.length === 0) {
        tbody.parentElement.parentElement.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      tbody.parentElement.parentElement.style.display = 'block';
      emptyState.style.display = 'none';

      tbody.innerHTML = customers.map(c => {
        const date = new Date(c.created_at).toLocaleDateString();
        return `
          <tr>
            <td>${c.id}</td>
            <td><strong>${c.name}</strong></td>
            <td>${c.email}</td>
            <td>${c.phone || 'N/A'}</td>
            <td>${date}</td>
            <td>
              <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="viewCustomer(${c.id})">ğŸ‘ï¸ View</button>
                <button class="btn btn-warning btn-sm" onclick="editCustomer(${c.id})">âœï¸ Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">ğŸ—‘ï¸ Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterCustomers() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = customers.filter(c =>
        c.name.toLowerCase().includes(search) ||
        c.email.toLowerCase().includes(search) ||
        (c.phone && c.phone.includes(search))
      );

      const tbody = document.getElementById('customersTable');
      tbody.innerHTML = filtered.map(c => {
        const date = new Date(c.created_at).toLocaleDateString();
        return `
          <tr>
            <td>${c.id}</td>
            <td><strong>${c.name}</strong></td>
            <td>${c.email}</td>
            <td>${c.phone || 'N/A'}</td>
            <td>${date}</td>
            <td>
              <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="viewCustomer(${c.id})">ğŸ‘ï¸ View</button>
                <button class="btn btn-warning btn-sm" onclick="editCustomer(${c.id})">âœï¸ Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${c.id})">ğŸ—‘ï¸ Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Customer';
      document.getElementById('customerForm').reset();
      document.getElementById('customerModal').classList.add('active');
    }

    function editCustomer(id) {
      const customer = customers.find(c => c.id === id);
      if (!customer) return;

      editingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Customer';
      document.getElementById('customerName').value = customer.name;
      document.getElementById('customerEmail').value = customer.email;
      document.getElementById('customerPhone').value = customer.phone || '';
      document.getElementById('customerAddress').value = customer.address || '';
      document.getElementById('customerModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('customerModal').classList.remove('active');
      editingId = null;
    }

    async function saveCustomer(e) {
      e.preventDefault();

      const data = {
        name: document.getElementById('customerName').value,
        email: document.getElementById('customerEmail').value,
        phone: document.getElementById('customerPhone').value,
        address: document.getElementById('customerAddress').value
      };

      try {
        const url = editingId ? `/api/customers/${editingId}` : '/api/customers';
        const method = editingId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          closeModal();
          loadCustomers();
        }
      } catch (error) {
        console.error('Error saving customer:', error);
        alert('Failed to save customer');
      }
    }

    async function deleteCustomer(id) {
      if (!confirm('Are you sure you want to delete this customer?')) return;

      try {
        const res = await fetch(`/api/customers/${id}`, { method: 'DELETE' });
        if (res.ok) {
          loadCustomers();
        }
      } catch (error) {
        console.error('Error deleting customer:', error);
        alert('Failed to delete customer');
      }
    }

    function viewCustomer(id) {
      window.location.href = `/customer.html?id=${id}`;
    }

    function exportCustomersCSV() {
      const data = customers.map(c => ({
        ID: c.id,
        Name: c.name,
        Email: c.email,
        Phone: c.phone || 'N/A',
        Address: c.address || 'N/A',
        Registered: new Date(c.created_at).toLocaleDateString()
      }));

      exportUtils.exportToCSV(data, `customers_${Date.now()}.csv`);
    }

    function exportCustomersPDF() {
      const data = customers.map(c => ({
        ID: c.id,
        Name: c.name,
        Email: c.email,
        Phone: c.phone || 'N/A',
        Registered: new Date(c.created_at).toLocaleDateString()
      }));

      exportUtils.exportToPDF('Customers List', data, `customers_${Date.now()}.pdf`);
    }

    loadCustomers();
  </script>
</body>
</html>
