<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory - Kart Management</title>
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="/" class="nav-brand">ğŸ›’ Kart Management</a>
      <div class="nav-links">
        <a href="/catalog.html">ğŸ“¦ Catalog</a>
        <a href="/inventory.html" class="active">ğŸ“Š Inventory</a>
        <a href="/cart.html">ğŸ›ï¸ Cart</a>
        <a href="/customers.html">ğŸ‘¥ Customers</a>
        <a href="/dashboard.html">ğŸ“ˆ Dashboard</a>
      </div>
    </div>
  </nav>

  <main>
    <div class="page-header">
      <h1>ğŸ“Š Inventory Management</h1>
      <div class="btn-group">
        <button class="btn btn-success" onclick="openAddModal()">â• Add Product</button>
        <button class="btn btn-warning" onclick="bulkUpdate()">ğŸ“¦ Bulk Update</button>
        <button class="btn btn-primary" onclick="exportUtils.exportProductsCSV(products)">ğŸ“„ Export CSV</button>
        <button class="btn btn-secondary" onclick="exportUtils.exportProductsPDF(products)">ğŸ“‘ Export PDF</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon primary">ğŸ“¦</div>
        <div class="stat-info">
          <h3>Total Products</h3>
          <p id="totalProducts">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon success">âœ…</div>
        <div class="stat-info">
          <h3>In Stock</h3>
          <p id="inStock">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon warning">âš ï¸</div>
        <div class="stat-info">
          <h3>Low Stock</h3>
          <p id="lowStock">0</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon danger">âŒ</div>
        <div class="stat-info">
          <h3>Out of Stock</h3>
          <p id="outOfStock">0</p>
        </div>
      </div>
    </div>

    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="Search inventory..." onkeyup="filterTable()">
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Product Name</th>
            <th>SKU</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="inventoryTable"></tbody>
      </table>
    </div>
  </main>

  <!-- Add/Edit Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Product</h2>
        <button class="close-btn" onclick="closeModal()">âœ•</button>
      </div>
      <form id="productForm" onsubmit="saveProduct(event)">
        <div class="form-group">
          <label>Product Name *</label>
          <input type="text" id="productName" required>
        </div>
        <div class="form-group">
          <label>SKU</label>
          <input type="text" id="productSku">
        </div>
        <div class="form-group">
          <label>Price *</label>
          <input type="number" id="productPrice" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Stock Quantity *</label>
          <input type="number" id="productStock" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="productDescription"></textarea>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-success">ğŸ’¾ Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/utils/export.js"></script>
  <script>
    let products = [];
    let editingId = null;

    async function loadInventory() {
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        products = data.data || [];
        renderTable();
        updateStats();
      } catch (error) {
        console.error('Error loading inventory:', error);
      }
    }

    function renderTable() {
      const tbody = document.getElementById('inventoryTable');
      tbody.innerHTML = products.map(p => {
        const status = p.stock === 0 ? 'Out of Stock' : p.stock <= 10 ? 'Low Stock' : 'In Stock';
        const badgeClass = p.stock === 0 ? 'badge-danger' : p.stock <= 10 ? 'badge-warning' : 'badge-success';
        
        return `
          <tr>
            <td>${p.id}</td>
            <td><strong>${p.name}</strong></td>
            <td>${p.sku || 'N/A'}</td>
            <td>$${parseFloat(p.price).toFixed(2)}</td>
            <td>${p.stock}</td>
            <td><span class="badge ${badgeClass}">${status}</span></td>
            <td>
              <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="editProduct(${p.id})">âœï¸</button>
                <button class="btn btn-success btn-sm" onclick="adjustStock(${p.id})">ğŸ“¦</button>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = products.filter(p => 
        p.name.toLowerCase().includes(search) || 
        (p.sku && p.sku.toLowerCase().includes(search)) ||
        p.id.toString().includes(search)
      );
      
      const tbody = document.getElementById('inventoryTable');
      tbody.innerHTML = filtered.map(p => {
        const status = p.stock === 0 ? 'Out of Stock' : p.stock <= 10 ? 'Low Stock' : 'In Stock';
        const badgeClass = p.stock === 0 ? 'badge-danger' : p.stock <= 10 ? 'badge-warning' : 'badge-success';
        
        return `
          <tr>
            <td>${p.id}</td>
            <td><strong>${p.name}</strong></td>
            <td>${p.sku || 'N/A'}</td>
            <td>$${parseFloat(p.price).toFixed(2)}</td>
            <td>${p.stock}</td>
            <td><span class="badge ${badgeClass}">${status}</span></td>
            <td>
              <div class="btn-group">
                <button class="btn btn-primary btn-sm" onclick="editProduct(${p.id})">âœï¸</button>
                <button class="btn btn-success btn-sm" onclick="adjustStock(${p.id})">ğŸ“¦</button>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateStats() {
      document.getElementById('totalProducts').textContent = products.length;
      document.getElementById('inStock').textContent = products.filter(p => p.stock > 10).length;
      document.getElementById('lowStock').textContent = products.filter(p => p.stock > 0 && p.stock <= 10).length;
      document.getElementById('outOfStock').textContent = products.filter(p => p.stock === 0).length;
    }

    function openAddModal() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add Product';
      document.getElementById('productForm').reset();
      document.getElementById('productModal').classList.add('active');
    }

    function editProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Product';
      document.getElementById('productName').value = product.name;
      document.getElementById('productSku').value = product.sku || '';
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productStock').value = product.stock;
      document.getElementById('productDescription').value = product.description || '';
      document.getElementById('productModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('productModal').classList.remove('active');
      editingId = null;
    }

    async function saveProduct(e) {
      e.preventDefault();
      
      const data = {
        name: document.getElementById('productName').value,
        sku: document.getElementById('productSku').value,
        price: parseFloat(document.getElementById('productPrice').value),
        stock: parseInt(document.getElementById('productStock').value),
        description: document.getElementById('productDescription').value
      };
      
      try {
        const url = editingId ? `/api/products/${editingId}` : '/api/products';
        const method = editingId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          closeModal();
          loadInventory();
        }
      } catch (error) {
        console.error('Error saving product:', error);
        alert('Failed to save product');
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      try {
        const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
        if (res.ok) {
          loadInventory();
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        alert('Failed to delete product');
      }
    }

    function adjustStock(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      const newStock = prompt(`Adjust stock for ${product.name}\nCurrent: ${product.stock}`, product.stock);
      if (newStock === null) return;
      
      updateStock(id, parseInt(newStock));
    }

    async function updateStock(id, stock) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      try {
        const res = await fetch(`/api/products/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...product, stock })
        });
        
        if (res.ok) {
          loadInventory();
        }
      } catch (error) {
        console.error('Error updating stock:', error);
        alert('Failed to update stock');
      }
    }

    function bulkUpdate() {
      alert('Bulk update feature - Add multiple products or update stock in batch');
    }

    loadInventory();
  </script>
</body>
</html>
